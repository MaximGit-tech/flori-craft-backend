from django.db import models
from django.utils import timezone
from datetime import timedelta


class PosifloraSession(models.Model):
    access_token = models.TextField()
    refresh_token = models.TextField()
    expires_at = models.DateTimeField()

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def is_expired(self, buffer_minutes=15):
        """Проверить истечение с буфером 15 минут"""
        buffer = timedelta(minutes=buffer_minutes)
        return timezone.now() >= (self.expires_at - buffer)
    
    def time_until_expiry(self):
        """Время до истечения"""
        return self.expires_at - timezone.now()
    
    def time_until_expiry_minutes(self):
        """Время до истечения в минутах"""
        delta = self.time_until_expiry()
        return int(delta.total_seconds() / 60)
